<%
  const pageTitle = 'Tableau de bord';
  const activeNav = 'dashboard';
  const totalArticles = articles.length;
  const totalSuppliers = 2;
  const totalLocations = 2;
  const totalValue = articles.reduce((acc, article) => acc + article.prix_unitaire * article.stock, 0);
  const lowStockThreshold = 20;
  const lowStockArticles = articles.filter((article) => article.stock <= lowStockThreshold);
  const renderBody = function () {
%>
  <section class="row g-4 mb-4">
    <div class="col-12 col-md-6 col-xl-3">
      <div class="stat-card">
        <p class="stat-label">Total articles</p>
        <p class="stat-value"><%= totalArticles %></p>
        <p class="stat-change">
          <i class="bi bi-arrow-up-right"></i>
          +12% ce mois-ci
        </p>
      </div>
    </div>
    <div class="col-12 col-md-6 col-xl-3">
      <div class="stat-card">
        <p class="stat-label">Fournisseurs actifs</p>
        <p class="stat-value"><%= totalSuppliers %></p>
        <p class="stat-change text-muted">
          <i class="bi bi-people"></i>
          Réseau stable
        </p>
      </div>
    </div>
    <div class="col-12 col-md-6 col-xl-3">
      <div class="stat-card">
        <p class="stat-label">Emplacements</p>
        <p class="stat-value"><%= totalLocations %></p>
        <p class="stat-change text-muted">
          <i class="bi bi-archive"></i>
          Zones de stockage
        </p>
      </div>
    </div>
    <div class="col-12 col-md-6 col-xl-3">
      <div class="stat-card">
        <p class="stat-label">Valeur totale</p>
        <p class="stat-value">
          <%= totalValue.toLocaleString('fr-FR', { style: 'currency', currency: 'XAF' }) %>
        </p>
        <p class="stat-change">
          <i class="bi bi-cash-coin"></i>
          Flux maîtrisé
        </p>
      </div>
    </div>
  </section>

  <div class="row g-4">
    <div class="col-12 col-xl-8">
      <section class="app-section">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
          <h2 class="section-title mb-0">Articles en stock</h2>
          <span class="badge bg-label">Mis à jour <%= new Date().toLocaleDateString('fr-FR') %></span>
        </div>

        <% if (!articles || articles.length === 0) { %>
          <div class="app-section-empty">
            Aucun article enregistré pour le moment. Utilisez le bouton « Nouvel article » pour commencer.
          </div>
        <% } else { %>
          <div class="row g-4">
            <% articles.forEach((article) => { %>
              <div class="col-12 col-md-6">
                <article class="card module-card h-100 border-0">
                  <div class="card-body d-flex flex-column gap-3">
                    <div>
                      <h3 class="h5 card-title mb-1"><%= article.designation %></h3>
                      <p class="card-subtitle small mb-0">
                        Code article :
                        <span class="badge bg-label"><%= article.code_article %></span>
                      </p>
                    </div>

                    <dl class="module-details small mb-0 flex-grow-1">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <dt class="text-muted mb-0">Stock disponible</dt>
                        <dd class="fw-semibold mb-0"><%= article.stock %> unités</dd>
                      </div>
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <dt class="text-muted mb-0">Prix unitaire</dt>
                        <dd class="fw-semibold mb-0">
                          <%= article.prix_unitaire.toLocaleString('fr-FR', { style: 'currency', currency: 'XAF' }) %>
                        </dd>
                      </div>
                    </dl>

                    <div class="d-flex align-items-center gap-2">
                      <span class="badge <%= article.avec_tva ? 'bg-success' : 'bg-secondary' %>">
                        <%= article.avec_tva ? 'TVA appliquée' : 'Sans TVA' %>
                      </span>
                      <% if (article.stock <= lowStockThreshold) { %>
                        <span class="badge text-bg-warning">Stock faible</span>
                      <% } %>
                    </div>
                  </div>
                </article>
              </div>
            <% }); %>
          </div>
        <% } %>
      </section>
    </div>

    <div class="col-12 col-xl-4">
      <section class="app-section mb-4">
        <h2 class="section-title">Alertes de stock</h2>
        <% if (lowStockArticles.length === 0) { %>
          <div class="app-section-empty">Aucune alerte. Vos stocks sont sous contrôle.</div>
        <% } else { %>
          <div class="alert-stock">
            <% lowStockArticles.forEach((article) => { %>
              <div class="alert-item">
                <span><%= article.designation %></span>
                <span class="badge rounded-pill"><%= article.stock %> unités</span>
              </div>
            <% }); %>
          </div>
        <% } %>
      </section>

      <section class="app-section">
        <h2 class="section-title">Statistiques</h2>
        <ul class="stats-list">
          <li>
            Articles en stock
            <span><%= articles.reduce((acc, article) => acc + (article.stock > 0 ? 1 : 0), 0) %></span>
          </li>
          <li>
            Articles en rupture
            <span><%= articles.reduce((acc, article) => acc + (article.stock === 0 ? 1 : 0), 0) %></span>
          </li>
          <li>
            Stocks bas (&le; <%= lowStockThreshold %>)
            <span><%= lowStockArticles.length %></span>
          </li>
          <li>
            Valeur moyenne
            <span>
              <%= (totalArticles > 0
                ? (totalValue / totalArticles)
                : 0).toLocaleString('fr-FR', { style: 'currency', currency: 'XAF' }) %>
            </span>
          </li>
        </ul>
      </section>
    </div>
  </div>
<%
  };
%>

<%- include('layout', { pageTitle, renderBody, activeNav }) %>
